declare @FieldID int,
		@CreatedUserID bigint

declare Cur cursor local for
select	
		f.FieldID,
		f.CreatedUserID
from [dbo].[fld_Field] f
inner join [dbo].[mdl_Table] mt 
	on	mt.ModuleID		= f.ModuleID
where (f.CreatedUserID <> -1 or f.CreatedUserID is null)
		and mt.TableName is not null
		and not exists(select 1 from information_schema.columns c 
							where	c.TABLE_NAME = mt.PhysicalName
								and c.COLUMN_NAME = f.FieldName
							)
open Cur

FETCH NEXT FROM Cur INTO @FieldID,@CreatedUserID

while ( @@FETCH_STATUS = 0 )
begin
	--1. Insert Role Field when add new field
	exec	sec_Insert_Role_Field_ByFieldID @FieldID, @CreatedUserID
	
	--2. Add new column into static table
	exec	fld_Insert_FieldName_StaticTable @FieldID, @CreatedUserID, null
	FETCH NEXT FROM Cur INTO @FieldID,@CreatedUserID
end
CLOSE Cur 
DEALLOCATE Cur 


declare			@TableID				int,
				@RecID					bigint
declare Cur cursor local for
select	distinct
		f.TableID,
		fv.RecID 
		from [dbo].[fld_Field_Value] fv
		inner join [dbo].[fld_Field] f
		on	fv.FieldID = f.FieldID
		where TableID in (1,2,3,5,6)
open Cur

FETCH NEXT FROM Cur INTO @TableID, @RecID

while ( @@FETCH_STATUS = 0 )
begin

declare			@PKFieldName			varchar(255),
				@Delim					varchar(5),
				@TableName				varchar(255),
				@Sql					nvarchar(max),
				@ModuleID				int

				set	@Delim						= ' '
				set @Sql						= ' '

		select	@TableName				= mt.PhysicalName,
				@PKFieldName			= mt.PKFieldName,
				@ModuleID				= mt.ModuleID

				from	mdl_Table mt (nolock)

		where	mt.TableID				= @TableID
declare	@UpdateFields		varchar(max)  = ''

		--1.1 Get field val
		select	@UpdateFields		= @UpdateFields + @Delim + '[' + ff.FieldName + ']' + ' = ' + 
										(case	when ff.FieldTypeID = 6 and isnull(FieldMemo,'') = '' then 
												'null'
											when ff.FieldTypeID = 6 then 
												(' ''' + FieldMemo + ''' ')
											when isnull(FieldVal,'') = '' then
												'null'
											else
												(' ''' + FieldVal + ''' ')
										end) + ' ',
				@Delim				= ','
			
		from	[dbo].[fld_Field_Value] fv

		inner join fld_Field ff (nolock)
			on	ff.FieldID			= fv.FieldID
			and	ff.FieldName		not in ('CreatedDate', 'CreatedBy', 'ModifiedDate', 'ModifiedBy')
			and ff.ModuleID			= 1

		where (ff.FieldTypeID		<> 12
			or ff.NumberOfValues	<> 2)
			and RecID = @RecID

			--1.2 Update data to table
			set	@Sql					= 
			' update	dbo.' + @TableName + 
			' set	' + @UpdateFields + 
			' where	' + @PKFieldName + ' = ' + convert(varchar, @RecID)
			--select  @Sql
			if(@UpdateFields is not null and LEN(LTRIM(RTRIM(@UpdateFields))) > 0)
			begin
				exec (@Sql)	
			end
FETCH NEXT FROM Cur INTO @TableID, @RecID
end
CLOSE Cur 
DEALLOCATE Cur 

 